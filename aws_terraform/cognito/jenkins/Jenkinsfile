pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '3'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    parameters {
        string(name: 'ENVIRONMENT', defaultValue: 'dev', description: 'dev | qa | prod')
        booleanParam(name: 'RUN_APPLY', defaultValue: false, description: 'Run terraform apply?')
        booleanParam(name: 'RUN_DESTROY', defaultValue: false, description: 'Run terraform destroy?')
    }

    environment {
        TF_BACKEND_BUCKET  = 'testing-epa-application-bucket19112025'
        TF_BACKEND_REGION  = 'ap-south-1'
        TF_BACKEND_KEY_BASE = 'cognito-identity-setup'
        TF_PLAN_FILE       = 'tfplan.binary'
        TF_FOLDER          = 'aws_terraform/cognito/cog_tf'
        
        // Each environment has its own plugin cache
        TF_PLUGIN_DIR      = ".terraform-${params.ENVIRONMENT}"
    }

    stages {

        stage('Checkout Repo') {
            steps {
                checkout scm
                script {
                    env.TF_BACKEND_KEY = "${TF_BACKEND_KEY_BASE}/${params.ENVIRONMENT}/terraform.tfstate"
                }
            }
        }

        stage('Prepare Terraform Environment') {
            steps {
                dir(env.TF_FOLDER) {
                    script {
                        // Create environment-based .terraform plugin directory
                        sh "mkdir -p ${env.TF_PLUGIN_DIR}"

                        // FORCE Terraform to use this directory
                        env.TF_DATA_DIR = "${env.WORKSPACE}/${env.TF_FOLDER}/${env.TF_PLUGIN_DIR}"

                        echo "Using environment-specific terraform plugin dir: ${env.TF_DATA_DIR}"
                    }
                }
            }
        }

        stage('Terraform Init (only if needed)') {
            steps {
                dir(env.TF_FOLDER) {
                    script {
                        def lockExists  = fileExists("${env.TF_PLUGIN_DIR}/.terraform.lock.hcl")
                        def tfDirExists = fileExists("${env.TF_PLUGIN_DIR}/plugins")

                        if (!lockExists || !tfDirExists) {
                            echo "Terraform NOT initialized for ${params.ENVIRONMENT} â€” running init..."
                            sh """
                                terraform init -reconfigure \
                                  -backend-config="bucket=${TF_BACKEND_BUCKET}" \
                                  -backend-config="key=${TF_BACKEND_KEY}" \
                                  -backend-config="region=${TF_BACKEND_REGION}" \
                                  -input=false
                            """
                        } else {
                            echo "Terraform already initialized for ${params.ENVIRONMENT}. Skipping init."
                        }
                    }
                }
            }
        }

        stage('Format & Validate') {
            steps {
                dir(env.TF_FOLDER) {
                    sh "terraform fmt -check -recursive || true"
                    sh "terraform validate -no-color"
                }
            }
        }

        stage('Plan') {
            steps {
                dir(env.TF_FOLDER) {
                    sh """
                        terraform plan \
                          -out=${TF_PLAN_FILE} \
                          -input=false
                    """

                    sh "terraform show -json ${TF_PLAN_FILE} > plan.json"
                }

                archiveArtifacts artifacts: "${env.TF_FOLDER}/plan.json"
            }
        }

        stage('Approval for Production Apply') {
            when { expression { params.RUN_APPLY && params.ENVIRONMENT == 'prod' } }
            steps {
                input message: "Approve APPLY for PRODUCTION?"
            }
        }

        stage('Apply') {
            when { expression { params.RUN_APPLY && !params.RUN_DESTROY } }
            steps {
                dir(env.TF_FOLDER) {
                    input message: "CONFIRM APPLY for ${params.ENVIRONMENT}?"
                    sh "terraform apply -auto-approve -input=false ${TF_PLAN_FILE}"
                }
            }
        }

        stage('Destroy') {
            when { expression { params.RUN_DESTROY } }
            steps {
                dir(env.TF_FOLDER) {
                    input message: "CONFIRM DESTROY for ${params.ENVIRONMENT}?"
                    sh "terraform destroy -auto-approve -input=false"
                }
            }
        }
    }

    post {
        success { echo "Pipeline completed successfully for ${params.ENVIRONMENT}" }
        failure { echo "Pipeline failed. Check logs." }
    }
}
